很多用于协作的原语常常在很多应用之间共享，因此，设计一个用于协作需求的服务的方法往往是提供原语列表，暴露出每个原语的实例化调用方法，并直接控制这些实例。

> 例如，分布式锁机制组成了一个重要的原语，同时暴露出创建（Create）、获取（Require）和释放（Release）三个调用方法。

**这种设计存在一些重大的缺陷：**
1. 要么预先提供一份详尽的原语列表
2. 要么提供API的扩展，以便引入新的原语
3. 这种方式实现原语的服务使得应用丧失了灵活性


> **zookeeper并不直接暴露原语，而是暴露由一小部分调用方法组成的类似文件系统的API，以便允许应用实现自己的原语。**

zookeeper操作和维护一个小型的数据节点（znode），类似于文件系统的层级树状结构进行管理。

# Zookeeper架构
应用通过客户端库对Zookeeper实现调用，客户端库负责与Zookeeper服务器端进行交互。

- 每个客户端导入客户端库，之后便可以与任何zookeeper的节点进行通信

## zookeeper服务器端运行模式
- 独立模式：一个单独的服务器，zookeeper状态无法复制
- 仲裁模式：一组zookeeper服务器构成集群，它们之间可以进行状态复制，并同时服务于客户端请求

### 集群模式（仲裁模式）
zookeeper复制集群中的所有服务器的数据树。如果让一个客户端等待每个服务器完成数据的保存后再继续，延迟问题将无法接受。
> 法定人数：为了使zookeeper集群正常工作必须有效运行的最小服务器数量。这个数字也是服务器告知客户端安全保存数据前，需要保存客户端数据的服务器的最小个数。

**法定人数的数量需要保证不管系统发生延迟或奔溃，服务主动确认的任何更新请求需要保持下去，直到另一个请求代替它。通常为多数原则，即集群个数的一半以上。**


通常集群中服务器的个数不一定必须是奇数，只是使用偶数会使得集群变个更加脆弱。假设集群中有4台服务器，为了满足多数原则，只能有一台服务器出现故障，而法定人数却更大，这意味着对每个请求需要有更多的确认操作。

## 会话
在对zookeeper集群执行任何请求前，客户端必须先与服务器建立会话。客户端提交给zookeeper的所有操作均关联在一个会话上。当一个会话因为某种原因而中止时，在这个会话期间创建的临时节点也会消失。

客户端通过TCP协议与服务器进行连接并通信，但当会话无法与当前连接的服务器继续通信时，会话就可能转移到另一个服务器上，zookeeper客户端库透明地转移一个会话到不同的服务器上。

> 会话提供了顺序保障，这就意味着同一个会话的请求会以FIFO顺序执行。通常一个客户端只打开一个会话，因此，同一个客户端的请求将全部以FIFO顺序执行。如果客户端拥有多个并发的会话，FIFO的顺序在多个会话之间未必能够保持，即使一个客户端中连贯的会话并不重叠，也很难保证FIFO的顺序。


## 会话的状态和声明周期
- 会话的生命周期：会话从创建到结束的时期，无论会话正常关闭还是因为超时而导致过期。

会话主要可能的状态：
- connecting
- connected
- closed
- not_connected

状态的转换依赖于发生在客户端与服务器之间的各种事件。

![image](https://note.youdao.com/yws/public/resource/ba3845df04801cd0f033bbbb1f9e732b/xmlnote/5AC1150D494A4AC1955E3600B1764AE9/13755)

0. 会话一开始为**not_connecte**d状态
1. 当客户端初始化后转换为**connecting**状态
2. 与服务器建立连接后转换为**connected**状态
3. 当客户端与服务器断开连接或者无法接收到服务器的响应时，转为**connecting**状态，并尝试发现其他zookeeper服务器；如果发现另一台服务器或者重连上原来的服务器，服务器确认会话有效后，状态转为**connected**
4. 会话超时（zookeeper服务器对声明会话超时负责，而不是客户端，但是客户端可以选择关闭会话），转为**closed**状态，或者显式的关闭会话，转为**closed**状态


### 会话超时
创建会话时，需要设置会话超时参数（t），这个参数设置了zookeeper服务器允许会话被声明为超时前存在的时间。经过时间t后，服务器设置这个会话超时。

客户端会在三分之一t的时间后，向服务器发送心跳消息。三分之二t的时间后，客户端开始寻找其他的服务器。

> 在集群模式（仲裁模式）中，应用需要显示传递可用的服务器列表给客户端

在zookeeper集群中，系统根据每一个更新建立的顺序来分配事物标识符（zkid），客户端在连接其他服务器时，不能连接更新状态不是最新状态的服务器。

