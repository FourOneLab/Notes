# 源代码安装
利用厂商发布的Tarball进行软件安装，在每次安装软件时都需要检测操作系统与环境，设置编译参数，最后指定软件安装位置。

# 安装包安装
厂商在固定的硬件平台和操作系统上面将需要安装或升级的软件编译好，然后将这个软件的所有相关文件打包成为一个特殊格式的文件。

> 在这个文件内还包含了**预先检测系统和依赖软件的脚本**，并记载该软件提供的**所有文件信息**。

客户端取得这个文件后：
1. 只要通过特定的命令来安装，那么该软件文件就会按照内部的的脚本来检测相关的**前驱软件**是否存在，**安装环境**是否符合需求。
2. 安装完成后，将该软件的信息写入**软件管理机制**中，已完成未来可以进行升级、删除等操作

## RPM & DPKG
Linux主流的两种软件安装方式。
| 名称| 描述|
|---|---|
|DPKG|Debian社区开发，派生于Debian的都可以使用，如B2D，Ubuntu
|RPM|Red Hat开发，很多发行版都使用，如Fedora，CentOS，SUSE

无论那种方式，都需要面对**软件属性依赖**的问题。

> 解决方式：将依赖属性的数据做成列表，在软件安装时，如果发生有依赖属性的软件，管理机制自动获取依赖的软件并同时安装。

## 在线升级
Linux发行厂商都提供**在线升级**机制，通过这个机制，原版光盘中就只要有第一次安装需要用到的软件，其他时候只要有网络，就能够获得开发上提供的任何软件。

| distribution代表| 软件管理机制| 使用命令| 在线升级机制（命令）|
|---|---|---|---|
|Red Hat/Fedora | RPM|rpm\rpmbuild|YUM(yum)|
|Debain/Ubuntu|DPKG|dpkg|APT(apt-get) 
|SuSE|RPM|rpm|Yast Online Update(YOU)

为了重复利用既有软件的功能，很多软件都会以**函数库**的形式释出部分功能，以方便其他软件调用。同时，为了节约用户的数据量，发行版在发布软件时回见软件分为**一般使用（`pam-**.rpm`）**和**开发使用(`pam-devel-**.rpm`)**两部分。

以上现象导致了软件依赖属性的问题：
1. 通常RPM文件中记录的依赖属性数据能够告诉我们缺少了什么依赖软件，需要手动先去安装好。
2. 另一种解决方案就是YUM，在线升级。将所有的依赖属性信息列成表，安装软件时先去查找表，然后与系统内已经安装的软件进行比较，将没有安装的依赖软件同时都安装好。

### YUM
通过分析RPN的标题数据后，根据个软件的相关性制作出属性依赖时的解决方案，然后可以自动处理软件的依赖属性问题，来解决软件安装、升级和删除的问题。

1. 将发布的软件都放在YUM服务器内
2. 分析软件的依赖属性，形成清单列表

列表数据与发布的软件存放的位置成为仓库（Repository）。

**想要使用yum就必须找到合适的yun服务器。每个yum服务器可能提供许多不用的软件功能，即仓库（Repository）**。

#### 安装或升级
1. 客户端通过网络向YUM服务器的repository下载或更新清单列表（存放在`/path/repodata/列表`）
2. 通过清单列表和本机RPM数据库中已经存在的软件数据进行比较（存放在`/var/cache/yum`）
3. 利用比较的结果从yum服务器中下载依赖的软件进行安装

> 仓库（Repository）的作用是用于存放不同的软件。因为不同的yum服务器上提供的RPM文件内容可能不同，比如原厂发布的数据有**原版数据**、**更新数据（update）**、**特殊数据（第三方软件或特殊功能的软件）**，这些软件文件基本不会放在一起。

### YUM配置
yunm服务器上会有非常多的链接，这些链接就是yum服务器所提供的仓库（Repository），包括：
- addons
- centosplus
- extras
- fasttrack
- os（系统默认的软件）
- updates（软件升级版本）
- 等等

yum服务器中的`repodata`目录是分析RPM软件后产生的软件属性依赖数据放置的位置。因此找仓库网址时，最重要的就是该网址下一定有一个repodata的目录存在，那么它就是一个仓库网址。

配置文件`/etc/yum.repos.d/***.repo`
```bash
[base] #代表仓库的名字，中括号必须存在，名字随意但必须唯一
name=CentOS-$releasever - Base  #描述这个仓库的名字
mirrorlist=http://mirrorlist.centos.org/?release=$releasever&arch=$basearch&repo=os&infra=$infra    #仓库可以使用的镜像站点
baseurl=http://mirror.centos.org/centos/$releasever/os/$basearch/   #这个很重要，指定的是仓库的实际网址
enable=1     #1表示使用这个仓库，0表示不使用
gpgcheck=1      #1 表示安装时要查看RPM文件中的数字证书，0表示不查看
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7     #数字证书的公钥存放的位置
```

**修改仓库配置文件可能会引起冲突问题:**
> yum首先从仓库中下载清单列表到本地的`/var/lib/yum`目录，当修改仓库的网址却没有修该仓库的名称时，会造成本机的列表与服务器的列表不同步的冲突，这样的话，yum就会无法更新

```bash
#删除本机中旧的数据
yum clean [package|headers|all]
# package，将已经下载的软件文件删除
# headers，将下载的软件文件头删除
# all，将所有仓库数据都删除 
```

# RPM & SRPM
## RPM
RPM全称“RedHat Package Manager”，以一种**数据库记录**的方式将所需要的软件安装到Linux系统的一套管理机制。**安装的过程实际就是把RPM文件中的内容放到Linux系统中对应的目录下**。

> RPM最大的特点，将需要安装的软件预先编译好，并且打包称为RPM机制的安装包，打包好的安装包里默认的数据库记录这个软件必须具备的依赖属性软件，当安装时，RPM会先按照安装包中的数据库记录查询Linux主机的依赖属性软件是否满足。安装时将该软件的信息写入RPM的数据库中，以便未来检查，验证，删除。

优点：
1. RPM中包含已经编译过的程序和设置文件等数据，所以软件传输与安装非常方便，免去重新编译的困扰
2. RPM在安装之前，会检查操作系统的硬盘容量、操作系统的版本等，可避免文件被错误安装
3. RPM文件本身提供软件版本信息，依赖属性软件名称，软件用途说明等，便于了解软件
4. RPM管理的方式，在Linux主机中使用数据库记录RPM文件相关参数，便于查询，升级，验证和删除


缺点：
1. 该软件文件几乎只能安装在原本默认的硬件与操作系统版本中
2. 通常不同的Linux发行版发布的RPM文件不能用在其他的发行版中
3. 可能相同发行版的不同系统版本也不能互通

## 默认安装路径
安装完成后，该软件相关的信息会被记录在`/var/lib/rpm`目录下的数据库文件中。**软件升级的版本比较，或者查询已安装的软件列表，都是读取这个数据库中的记录**。RPM相关的数字证书信息也是保存在该目录中。

> 如果`/var/lib/rpm`目录中的文件损坏了，可以通过`rpm --rebuilddb`进行数据库的重建。

RPM文件中的软件被分别放置在一下目录中：
| 目录|放置的内容|
|---|---|
|/etc|配置文件|
|/usr/bin|可执行文件|
|/usr/lib|程序使用的动态函数库|
|/usr/share/doc|基本的软件使用手册和帮助文档|
|/usr/share/man| man page 文件|

## RPM验证
验证的功能主要是通过一种有效的管理机制，使用`/var/lib/rpm`下面的数据库内容来比较目前Linux系统的环境下的所有软件文件。
> 通常在软件误删，数据丢失，错误修改配置文件时使用。

```bash
rpm -V #后面加软件名称，如果该软件所含文件改动过，才会被列出来
rpm -Va #列出目前系统上所有可能被改过的文件
rpm -Vp #后面加文件名称，列出该软件内可能被改动过的文件
rpm -Vf #列出某个文件是否被改动过
```

列出的文件包含的参数和文件的类型：
|参数值|含义
|---|---|
|S（file size differs）|文件的容量大小是否被改变
|M（Modediffers）|文件的类型或文件的属性（RWX）是否被改变
|5（MD5 sum differs）|MD5内容是否改变
|D（Device major/minor number mis-match）|是被的主/次代码已经改变
|L（readLink 2 path mis-match）|Link路径已被改变
|U（User ownership differs）|文件的所有者已改变
|G（Group ownership differs）|文件的所属用户组已经改变
|T（mTime differs）|文件的创建时间已经被改变

|文件类型|含义
|---|---|
|c|配置文件（configfile）
|d|文档（document）
|g|鬼文件（ghost file）通常是该文件不被某个软件所包含，较少发生
|l|授权文件（license file）
|r|自述文件（read me）

经过验证可以知道哪个文件被改动过，一般配置文件被改动是正常的，如果二进制文件被改动就要特别注意。

## 数字证书
上述验证功能只能验证软件内信息和`/var/lib/rpm`数据库中的信息，如果**该软件文件所提供的数据信息本身**就有问题，那要怎么验证？

> 在Tarball与文件验证方面通常采用MD5校验。

但是文件数据中MD5很可能被篡改，这时就需要使用数字证书。为每个软件产生一个专属的数字证书，并将与该证书配套的公钥发布出来。

### 安装RPM文件的过程
1. 安装厂商发布的该文件的公钥文件,执行 `rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7`
2. 安装厂商的软件时，RPM管理机制会读取文件中的证书信息，与本机系统内的公钥信息进行比对
3. 比较结果相同则安装，否则发出警告并停止安装

CentOS使用的数字证书系统是GnuPG（GNU Privacy Guard，GPG），GPG通过复杂的运算产生独一无二的专属秘钥和数字证书。

**数字证书位于`/etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7`**。安装后是一个名字中包含pubkey的软件。
## SRPM
SRPM是Source RPM的意思，即这个文件中包含源代码，SRPM所提供的软件内容并没有经过编译。通常的格式为`***.src.rpm`。

SRPM与Tarball的区别：
1. 虽然都是源代码，但是SRPM中还包含该软件所需的依赖属性软件和相关的安装信息。
2. 它还提供了参数设置文件（configure与makefile）

所以在安装软件时：将该软件以RPM管理的方式编译，SRPM会被编译为RPM文件，将编译好的文件再进行安装。

|文件格式|文件名格式|能否直接安装|内含程序类型|能否修改参数并编译|
|---|---|---|---|---|
|RPM|***.rpm|能|已编译|不能
|SRPM|***.src.rpm|不能|未编译的源代码|能

## 软件的命名
|软件名称|-|软件的发布信息|-|发布的次数|.|适合的发行版|.|适合的硬件平台|.|扩展名
|---|---|---|---|---|---|---|---|---|---|---|---|
|docker-ce|-|18.09.3|-|3|.|el7|.|x86_64|.|rpm

> 注：适合的硬件平台显示为`noarch`时，就是没有任何硬件等级上的限制。**一般情况下，这种类型的RPM文件里面应该没有二进制程序存在，较常出现的就是属于shell script方面的软件**

**硬件平台通常向下兼容：**即低版本的软件可以安装在高版本的硬件平台（主要是CPU）上。只是性能上会有影响。
